#!/usr/bin/env python3
"""
GWAS, Multiomics & Bioinformatics Workshop - Deployment Status Check

This script checks the deployment status of the workshop components
and provides detailed feedback on repository health.

Author: Dr. Siddalingaiah H S
"""

import os
import sys
import subprocess
import requests
from pathlib import Path
import json

class DeploymentChecker:
    def __init__(self, github_username="hssling", repo_name="GWAS_Multiomics_Bioinformatics_Workshop"):
        self.github_username = github_username
        self.repo_name = repo_name
        self.repo_url = f"https://github.com/{github_username}/{repo_name}"
        self.pages_url = f"https://{github_username}.github.io/{repo_name}"
        self.streamlit_url = f"https://{repo_name.replace('_', '-')}-{github_username}.streamlit.app"

        print("üîç GWAS & Multiomics Bioinformatics Workshop - Deployment Checker")
        print("=" * 70)
        print(f"Repository: {self.repo_url}")
        print(f"Pages URL:  {self.pages_url}")
        print(f"Streamlit:   {self.streamlit_url}")
        print()

    def check_local_repository(self):
        """Check local Git repository status"""
        print("üìÅ Local Repository Status:")
        print("-" * 30)

        try:
            # Check if Git repository
            result = subprocess.run(["git", "status"], capture_output=True, text=True, cwd=".")
            if result.returncode == 0:
                print("‚úÖ Git repository initialized")

                # Check for uncommitted changes
                if "nothing to commit" in result.stdout:
                    print("‚úÖ All changes committed")
                else:
                    print("‚ö†Ô∏è  Uncommitted changes detected")
                    print("   Run: git add . && git commit -m \"update\"")

                # Check remote
                remote_result = subprocess.run(["git", "remote", "-v"], capture_output=True, text=True)
                if self.repo_url in remote_result.stdout:
                    print("‚úÖ GitHub remote configured")
                else:
                    print("‚ùå GitHub remote not configured")
                    print(f"   Run: git remote add origin {self.repo_url}")

            else:
                print("‚ùå Not a Git repository")
                print("   Run: git init")

        except FileNotFoundError:
            print("‚ùå Git not installed or not in PATH")

    def check_file_structure(self):
        """Check that all required files are present"""
        print("\nüìÇ Repository Structure Check:")
        print("-" * 35)

        required_files = [
            "README.md",
            "app.py",
            "requirements.txt",
            "LICENSE",
            ".gitignore",
            ".streamlit/config.toml",
            ".github/workflows/ci-cd.yml",
            ".github/workflows/pages.yml"
        ]

        required_dirs = [
            "Sessions",
            "Data",
            "Exercises",
            "Quizzes",
            "Scripts"
        ]

        # Check files
        all_files_good = True
        for file_path in required_files:
            if os.path.exists(file_path):
                print(f"‚úÖ {file_path}")
            else:
                print(f"‚ùå Missing: {file_path}")
                all_files_good = False

        # Check directories
        for dir_path in required_dirs:
            if os.path.exists(dir_path):
                # Count files in directory
                file_count = len(list(Path(dir_path).rglob("*"))) - len(list(Path(dir_path).rglob("*/")))
                print(f"‚úÖ {dir_path}/ ({file_count} files)")
            else:
                print(f"‚ùå Missing: {dir_path}/")
                all_files_good = False

        if all_files_good:
            print("\n‚úÖ All required files and directories present")
        else:
            print("\n‚ùå Some files/directories missing - run the file creation commands again")

    def check_github_repository(self):
        """Check GitHub repository status via API"""
        print("\nüêô GitHub Repository Check:")
        print("-" * 28)

        try:
            # Check repository exists
            api_url = f"https://api.github.com/repos/{self.github_username}/{self.repo_name}"
            response = requests.get(api_url)

            if response.status_code == 200:
                repo_data = response.json()
                print("‚úÖ Repository exists on GitHub")
                print(f"   Stars: {repo_data.get('stargazers_count', 0)}")
                print(f"   Forks: {repo_data.get('forks_count', 0)}")
                print(f"   Size: {repo_data.get('size', 0)} KB")

                # Check if public
                if repo_data.get('private', True):
                    print("‚ùå Repository is private")
                    print("   Make it public in repository Settings ‚Üí Danger Zone")
                else:
                    print("‚úÖ Repository is public")

                # Check topics
                topics = repo_data.get('topics', [])
                if 'bioinformatics' in topics and 'genomics' in topics:
                    print("‚úÖ Repository topics configured")
                else:
                    print("‚ö†Ô∏è  Repository topics not fully configured")
                    print("   Add topics: bioinformatics, genomics, multiomics, gwas")

            elif response.status_code == 404:
                print("‚ùå Repository does not exist on GitHub")
                print("   Create repository at: https://github.com/new")
                print(f"   Name: {self.repo_name}")
            else:
                print(f"‚ùå API error: HTTP {response.status_code}")

        except requests.RequestException as e:
            print(f"‚ùå Cannot connect to GitHub API: {e}")
            print("   Check internet connection")

    def check_github_pages(self):
        """Check GitHub Pages deployment"""
        print("\nüìÑ GitHub Pages Check:")
        print("-" * 24)

        try:
            response = requests.get(self.pages_url)
            if response.status_code == 200:
                print("‚úÖ GitHub Pages deployed successfully")
                print(f"   URL: {self.pages_url}")

                # Check if it contains workshop content
                if "GWAS" in response.text and "Bioinformatics" in response.text:
                    print("‚úÖ Pages contain workshop documentation")
                else:
                    print("‚ö†Ô∏è  Pages content may not be properly generated")

            elif response.status_code == 404:
                print("‚ùå GitHub Pages not deployed")
                print("   Check: Repository Settings ‚Üí Pages")
                print("   Source: Deploy from a branch")
                print("   Branch: main, Folder: docs/")
            else:
                print(f"‚ùå Pages error: HTTP {response.status_code}")

        except requests.RequestException as e:
            print(f"‚ùå Cannot access Pages URL: {e}")

    def check_streamlit_deployment(self):
        """Check Streamlit deployment"""
        print("\nüñ•Ô∏è Streamlit Deployment Check:")
        print("-" * 32)

        try:
            response = requests.get(self.streamlit_url)
            if response.status_code == 200:
                print("‚úÖ Streamlit app deployed successfully")
                print(f"   URL: {self.streamlit_url}")

                # Check if workshop app is loading
                if "GWAS" in response.text:
                    print("‚úÖ Workshop application running")
                else:
                    print("‚ö†Ô∏è  App may not be loading correctly")

            elif response.status_code in [404, 503]:
                print("‚ùå Streamlit app not deployed")
                print("   Deploy at: https://share.streamlit.io")
                print("   Connect repository and set main file path: app.py")
            else:
                print(f"‚ùå Deployment error: HTTP {response.status_code}")

        except requests.RequestException as e:
            print(f"‚ùå Cannot access Streamlit URL: {e}")

    def check_github_actions(self):
        """Check GitHub Actions status"""
        print("\n‚öôÔ∏è GitHub Actions CI/CD Check:")
        print("-" * 32)

        try:
            api_url = f"https://api.github.com/repos/{self.github_username}/{self.repo_name}/actions/runs"
            response = requests.get(api_url)

            if response.status_code == 200:
                runs_data = response.json()
                runs = runs_data.get('workflow_runs', [])

                if runs:
                    latest_run = runs[0]  # Most recent run
                    status = latest_run.get('status', 'unknown')
                    conclusion = latest_run.get('conclusion', 'unknown')

                    if status == 'completed' and conclusion == 'success':
                        print("‚úÖ Latest GitHub Actions run successful")
                    elif status == 'completed' and conclusion == 'failure':
                        print("‚ùå Latest GitHub Actions run failed")
                        print("   Check: Repository Actions tab for details")
                    elif status == 'in_progress':
                        print("‚è≥ GitHub Actions currently running")
                    else:
                        print(f"‚ö†Ô∏è  Actions status: {status}/{conclusion}")
                else:
                    print("‚ùå No GitHub Actions runs found")
                    print("   Actions should run automatically on push")

            else:
                print(f"‚ùå Cannot check Actions status: HTTP {response.status_code}")

        except requests.RequestException as e:
            print(f"‚ùå Cannot connect to GitHub API: {e}")

    def generate_deployment_report(self):
        """Generate comprehensive deployment report"""
        print("\nüìã DEPLOYMENT STATUS REPORT")
        print("=" * 70)

        self.check_local_repository()
        self.check_file_structure()
        self.check_github_repository()
        self.check_github_pages()
        self.check_streamlit_deployment()
        self.check_github_actions()

        print("\nüéØ DEPLOYMENT RECOMMENDATIONS")
        print("=" * 70)
        print("If any checks failed above, follow these steps:")
        print()
        print("1. üêô GitHub Repository:")
        print("   - Create at: https://github.com/new")
        print(f"   - Name: {self.repo_name}")
        print("   - Make public, no README initialization")
        print()
        print("2. üì§ Push Code:")
        print("   - Run: python deployment_check.py (to see git status)")
        print("   - Run the commands in git_push_commands.txt")
        print()
        print("3. ‚öôÔ∏è Enable Features:")
        print("   - GitHub Pages: Settings ‚Üí Pages ‚Üí Deploy from docs/")
        print("   - Streamlit: share.streamlit.io ‚Üí Connect repository")
        print("   - Topics: Add bioinformatics, genomics, gwas tags")
        print()
        print("4. üîç Verify Deployment:")
        print(f"   - Repository: {self.repo_url}")
        print(f"   - Pages: {self.pages_url}")
        print("   - Streamlit: Check share.streamlit.io for your deployment")
        print()
        print("üéâ Target URLs after successful deployment:")
        print(f"   üìñ Repository: {self.repo_url}")
        print(f"   üìÑ Documentation: {self.pages_url}")
        print("   üñ•Ô∏è Interactive App: [Check Streamlit Cloud after deployment]")

def main():
    """Main deployment check function"""
    if len(sys.argv) > 1:
        username = sys.argv[1]
        repo_name = sys.argv[2] if len(sys.argv) > 2 else "GWAS_Multiomics_Bioinformatics_Workshop"
    else:
        username = "hssling"
        repo_name = "GWAS_Multiomics_Bioinformatics_Workshop"

    checker = DeploymentChecker(username, repo_name)
    checker.generate_deployment_report()

if __name__ == "__main__":
    main()
